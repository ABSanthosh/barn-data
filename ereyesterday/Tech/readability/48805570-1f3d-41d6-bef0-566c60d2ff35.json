{
  "id": "48805570-1f3d-41d6-bef0-566c60d2ff35",
  "title": "Breaking the 4Chan CAPTCHA",
  "link": "https://www.nullpt.rs/breaking-the-4chan-captcha",
  "description": "Comments",
  "author": "",
  "published": "Fri, 29 Nov 2024 20:32:22 +0000",
  "source": "https://news.ycombinator.com/rss",
  "categories": null,
  "byline": "blackjack",
  "length": 17568,
  "excerpt": "In this blog post, I will talk about my successful experiment in machine learning using TensorFlow to automate solving the 4Chan CAPTCHA.",
  "siteName": "",
  "favicon": "",
  "text": "Breaking the 4Chan CAPTCHAIntroduction This project was entered into as a learning experience, to enhance my knowledge of machine learning, as well as TensorFlow specifically. At the end, I wanted to have a trained machine learning model that runs in the browser to reliably (at least 80% accuracy, \u003e90% preferred) solve the 4Chan CAPTCHA. These goals were achieved - let's talk about how I got there! If you'd like to follow along with the code references, I have made the code public on GitHub here. Terminology CAPTCHA: A challenge-response test to determine whether or not a computer or website user is a human. The acronym stands for Completely Automated Public Turing test to tell Computers and Humans Apart. 4Chan: A public, anonymous imageboard website with discussion boards on various topics. These boards are used for posting images and text discussions. Filling out a CAPTCHA is required before every post or reply. Normal CAPTCHA: The simplest form of the 4Chan CAPTCHA, that consists of an image with 5 or 6 alphanumeric characters. The user must read and correctly enter all of the characters in a field in order to make a post on 4Chan. Slider CAPTCHA: A more complex form of the 4Chan CAPTCHA, that consists of a background image with random-looking character fragments, and a foreground image with transparent \"holes\" or \"windows\" in it. A slider in the browser CAPTCHA form must be moved to correctly align the two images in order to see the CAPTCHA text. Getting the Data I've heard many times that the hardest part of any machine learning problem is getting the data to train your model. This assertion was definitely pertinent here, for several reasons. There's two parts to this problem: Getting the CAPTCHAs, and getting solutions to those CAPTCHAs. Scraping CAPTCHAs from 4Chan After looking at the HTTP requests in the browser console when requesting a new CAPTCHA, I found that it makes a request to https://sys.4chan.org/captcha?framed=1\u0026board={board}, where {board} is the name of the board we're trying to post on. The response is an HTML document that contains a script tag with a window.parent.postMessage() call with some JSON. On a hunch, I tried to remove the framed=1 parameter, and found that this causes it to just spit out the raw JSON. That should be easier to work with. The JSON looks like this: { \"challenge\": \"[some long and random string here]\", \"ttl\": 120, \"cd\": 5, \"img\": \"[a base64 string here]\", \"img_width\": 300, \"img_height\": 80, \"bg\": \"[a base64 string here]\", \"bg_width\": 349 } Some of these keys are pretty obvious. ttl and cd are the least obvious to me. I know from experience that the 4Chan CAPTCHA only displays for about 2 minutes before it expires and you have to request a new one, so that's what ttl must be. But what about cd? Let's make another request, shortly after the first one: { \"error\": \"You have to wait a while before doing this again\", \"cd\": 23 } If I keep making the same request, the cd parameter steadily decreases, at a rate of about 1 per second. Alright, so this is how long you have to wait before requesting a new CAPTCHA. cd likely stands for \"cooldown\". If I wait the 23 seconds, and then make another request, I get a successful response, but this time, the cd is 32. We have to wait longer every time. After some experimentation with a script, it looks like the first few requests can be made every 5 seconds, then it increments to 8, and then continues to roughly double until it's capped at 280 seconds, and stays there. Additionally, once you've hit the 280 second timers, the CAPTCHA gets somewhat harder. It looks like this: Difficult 4Chan CAPTCHA with several horizontal lines and an oval obscuring the text, in addition to general noise all over the image instead of this: Easier 4Chan CAPTCHA with one curved line over the text, in addition to general noise all over the image So, there's some throttling in place. The data also gets of lower (but still usable) quality if you make too many requests. Something I will briefly touch on is that the user has to pass a Cloudflare Turnstile challenge to even request a CAPTCHA in the first place. As a result, simply using many proxies with a naive script is not realistic, without first passing the Cloudflare Turnstile and saving the relevant cookies. When I was scraping CAPTCHAs with the script I wrote for this, I simply copied the Cloudflare cookies from my browser, and manually replaced them whenever they expired. I scraped several hundred CAPTCHAs in this manner - not enough to train the model, but it's at least a start. This still leaves us with a problem, though. We have all these CAPTCHAs, but we don't have the solutions. I could fill them out manually, but instead, let's try something else. Getting the Solutions Or, Humans are bad at solving the 4Chan CAPTCHA. A recurring theme in this project has been \"this is easy for a computer to do, but hard for a human to do.\" Many users find the \"slider\" style CAPTCHAs incredibly frustrating, but I've had a 100% success rate in aligning them with the heuristic script I made (trainer/captcha_aligner.py). The 4Chan CAPTCHAs in general are widely considered by users of the site to be frustrating to solve. But, surely, for people who solve CAPTCHAs for a living, it shouldn't be an insurmountable challenge, right? I coded a quick script (seen in the project under trainer/labeler.py) to send the CAPTCHAs to a commercial CAPTCHA solving service, where real humans would solve the CAPTCHAs for me for a nominal fee. Writing the script was simple, but actually employing it was an exercise in frustration. I sent a couple dozen CAPTCHAs to the service, and nearly all of them came back with one or more characters incorrectly solved. The service has a feature called \"100% Recognition\", which allowed me to specify that all my requests be first sent to n workers, and if x of those workers don't return the same solution, then send them to up to y more workers. It would only return an error after sending the CAPTCHAs to n + y workers and not getting at least x solutions the same. I configured my account with the values n = 2, x = 2, and y = 3 - that is, initially send the CAPTCHA to 2 workers, and if they don't both agree, then send them to up to 3 additional workers until two of them agree, or none of them agree. This improved the situation somewhat. About 80% of the CAPTCHAs were now being successfully solved, and after reviewing the results, 90% of those were correct, but about 10% had errors in them, which indicated that multiple workers were making the same mistakes. This was still less than ideal. A quick aside: What if I just ask someone I know to be reliable to do it for me, or even do it myself? I explored both of these approaches. I wrote a quick user script that saved the CAPTCHA image and the solution text, and just sat there requesting and solving CAPTCHAs in my free time. I also asked a good friend of mine to do the same. This yielded several hundred images, which I did add to the training set, but in the end this approach was abandoned because we still ran into the throttling problem, and the problem of the CAPTCHAs getting harder (and eventually, near-impossible) if you request too many of them. I begun to wonder if there was a different way to look at this altogether. What if we didn't need to scrape CAPTCHAs and have them solved by humans? Generating Synthetic Data What if we could generate our own 4Chan CAPTCHAs? 4Chan, and the CAPTCHA it uses, are not open source, so I couldn't literally run the same code locally. But I could definitely approximate it. The 4Chan CAPTCHA can be dissected into two main parts. The background, which looks like this: 4Chan CAPTCHA background with the characters removed, leaving only general noise over the image and the characters, which look like this: 4Chan CAPTCHA character set, the characters 0, 2, 4, A, D, G, H, K, M, N, P, S, X, and Y with general noise and distortion We don't need to generate our own backgrounds from scratch. It's a relatively simple computer vision problem to take an image like the 4Chan CAPTCHA, and find all of the large contours in the image, which represent the characters, and remove them. This leaves only the noisy background, as seen in the image above, which was generated using this algorithm. Next, we need to isolate a decent number of characters, and label them with their values. If this was trivial to do with an algorithmic script, well, we wouldn't be here, because solving the CAPTCHA would also be trivial to do with an algorithmic script :) It's pretty easy to do this by hand, though, and that's what I settled on doing. It was annoying. I tagged the characters with VoTT and then extracted them with a quick and dirty script, which also postprocessed them to make sure it was only the characters in the images. I ended up with 50-150 isolated images of each character. It was during this stage of the project that I realized the 4Chan CAPTCHA incoudes only the characters 0, 2, 4, A, D, G, H, K, M, N, P, S, X, and Y - likely done to avoid ambiguity. Now we just have to put it all together. When extracting the digits, I observed a few patterns in how the characters are usually clustered or spread apart, and so I wrote my script to assemble images with backgrounds according to these formulas. And, of course, since the input character images are labelled, I can easily label the generated synthetic CAPTCHAs with their solutions. Creating the Model Now we've got the data, it's time to train the model. I assembled a model architecture based on some research, after reading several different articles on CAPTCHA solving using neural networks. I settled on an LSTM CNN architecture with 3 convolutional/max-pooling layers and 2 LSTM layers. A fourth convolutional layer was also tested, but it did not improve performance. CTC encoding of the CAPTCHA text was used, because the output was of variable length (either 5 or 6 characters). I built the model using Keras on top of TensorFlow. Processing the data The input to the model was a mix of pre-aligned slider CAPTCHAs, normal CAPTCHAs, and synthetic CAPTCHAs. The training script took care of ensuring they were 300x80 pixels and converted to pure black-and-white. Always read the docs The arguments might not be in the order you expect. One of the important steps in my data processing pipeline was making sure that all the CAPTCHA images are exactly 300x80 pixels. Some images from the dataset, namely the older aligned \"slider\" CAPTCHAs, don't match this resolution / aspect ratio. I could just fix the training data, but it's better in the end to make the training script able to cope with any data I throw at it. I used tf.image.resize() for this. The docs on this are pretty simple, for my use case I just need to pass the input image tensor, and the size, which is probably just a tuple of (width, height), right? Well, I made that assumption, and the code ran fine, so I didn't really give it a second thought. Until... My model's performance was absolutely abysmal! Even after training for 32+ epochs, the model barely performed at all on images it had seen before, and it really couldn't make anything at all of brand new CAPTCHA images, yielding seemingly random predictions. What the heck was going on? I decided to actually visualize the images I was feeding into the model, and see what they looked like - maybe my black/white thresholding was going wrong? I took a random image from the input data after processing, and visualized it, and I got... this: 4Chan CAPTCHA that is vertically stretched to 80x300 pixels and completely unreadable Yeah, you probably saw that coming as soon as I said \"probably just a tuple of (width, height)\". Turns out it's not. It is, in fact, a tuple of (height, width)! Had I taken the time to read the whole documentation page, I would have found this near the bottom of the page, where it provides more detail on the expected argument. This is definitely a lesson learned - read the documentation thoroughly when working with libraries you're unfamiliar with, even if you think you know how it works, and especially if things aren't working how you'd expect. After fixing this bug, the training performance looked a lot more promising. Training the model The final dataset consisted of approximately 500 hand-solved images, and approximately 50,000 synthetically-generated images. The synthetic images were generated based on random samples from approximately 2,500 background images and 50-150 images of each character. This dataset was randomly shuffled, and then segmented 90/10 into training and evaluation sets. Training took approximately 45 seconds per epoch on my NVIDIA RTX A4000 Laptop GPU. At the end of the first epoch, the loss did not look very promising - it's still all the way up at 19. During the evaluation callback phase, predictions were nowhere near correct, yielding only 1-2 predicted characters that didn't match any of the characters in the image. This is to be expected during the early stages of training. Later epochs greatly improved performance. By the end of the fourth epoch, loss decreased to 0.55, and the predictions were already looking good, with 5/5 of the random test predictions at this stage yielding correct results. Loss steadily decreased throughout the rest of the training epochs. After experimenting with different numbers of epochs, 8-16 epochs was found to be a good trade-off between time and final model performance. Loss stabilized by the 8th epoch, and increasing the epoch count beyond 16 yielded greatly diminishing returns. Graph of model loss versus epochs, showing initial large decrease followed by steady decline and levelling out I wrote a quick test script (trainer/infer.py) to infer CAPTCHA solutions in Python. Results were promising on images the model had not seen before, yielding correct solutions in the limited number of test cases I tried. Using the Model in TensorFlow.js Writing the TensorFlow.js code for the user script was quite straightforward. I chose TypeScript for this task. I re-implemented the CAPTCHA alignment algorithm from the Python code, as well as the image preprocessing code. All of this code is located in the user-scripts/ directory in the repository. The Python TensorFlow/Keras model formats aren't compatible with the model format expected by TensorFlow.js. There's an official conversion script, with instructions on how to use it. This should be easy, right? The converter doesn't work on Python 3.12 This was a pretty simple problem that took awhile to figure out. The official TensorFlow-to-TFJS model converter doesn't work on Python 3.12. This doesn't seem to really be documented, and the error messages thrown when you try to use it on Python 3.12 are non-obvious. I tried an older version of Python (3.10) on a hunch, using PyEnv, and it worked like a charm. TensorFlow.js doesn't support Keras 3 New problem: The conversion script supports converting Keras 3 models to TensorFlow.js format. The only problem? TensorFlow.js doesn't support actually reading those converted models. I found this out from a forum post, after I spent a bit of time puzzling out why TFJS wouldn't read the model that the official conversion script output. Luckily, the solution was easy: Use Keras 2. We can do this by training the model with the environment variable TF_USE_LEGACY_KERAS=1 set, after installing the legacy tf_keras package. This may require some code changes. In my case, I only had to trivially modify one line. We also have to export the model using the legacy .h5 model format, and specify that as the input format when running the conversion script. Real-World Performance We've seen the performance on the training dataset, which consists mainly of synthetic images. But it doesn't matter if it can solve synthetic CAPTCHAs - we care about solving the real ones. Good news: It works great on the real 4Chan CAPTCHA. Solving is fast, taking about 1 second to load the model the first time, and then being imperceptibly quick on subsequent executions. In my experience over hundreds of real CAPTCHAs solved in the browser, the model exhibits a greater than 90% successful solve rate. It rarely gets characters wrong - when it is innacurate, it typically omits a single character entirely. I believe this could be improved with greater training on actual data, or possibly tweaking the CAPTCHA layouts in the synthetic dataset generator. Animation of requesting a CAPTCHA in the 4Chan post form, and it being automatically solved by the user script. Small fun fact: This model has far better accuracy than the human-powered CAPTCHA solving service I described above. 4-character CAPTCHAs While I was writing and editing this article after completing the project, I noticed that 4Chan begun sometimes serving CAPTCHAs with only 4 characters, rather than the usual 5 and 6-character CAPTCHAs. Despite this model only having been trained on 5 and 6-character CAPTCHAs, performance on the 4-character CAPTCHAs is the same as for the 5 and 6-character CAPTCHAs. Conclusion I enjoyed this project a lot. It had a few challenges to overcome, and I learned a ton about machine learning and computer vision in the process. There are surely improvements that can be made, but for now, I'm pleased with the results, because I achieved what I set out to do from the start. I hope you enjoyed reading this write-up as much as I enjoyed writing it, and I hope you learned something too!",
  "image": "",
  "html": "\u003cdiv id=\"readability-page-1\" class=\"page\"\u003e\u003cdiv\u003e\u003cp\u003e\u003cspan\u003eBreaking the 4Chan CAPTCHA\u003c/span\u003e\u003c/p\u003e\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eThis project was entered into as a learning experience, to enhance my knowledge of machine learning, as well as TensorFlow specifically. At the end, I wanted to have a trained machine learning model that runs in the browser to reliably (at least 80% accuracy, \u0026gt;90% preferred) solve the 4Chan CAPTCHA. These goals were achieved - let\u0026#39;s talk about how I got there!\u003c/p\u003e\n\u003cp\u003eIf you\u0026#39;d like to follow along with the code references, I have made the code public on GitHub \u003ca href=\"https://github.com/AppleDash/4chan-captcha-playground\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n\u003ch2 id=\"terminology\"\u003eTerminology\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eCAPTCHA\u003c/strong\u003e: A challenge-response test to determine whether or not a computer or website user is a human. The acronym stands for Completely Automated Public Turing test to tell Computers and Humans Apart.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e4Chan\u003c/strong\u003e: A public, anonymous imageboard website with discussion boards on various topics. These boards are used for posting images and text discussions. Filling out a CAPTCHA is required before every post or reply.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eNormal CAPTCHA\u003c/strong\u003e: The simplest form of the 4Chan CAPTCHA, that consists of an image with 5 or 6 alphanumeric characters. The user must read and correctly enter all of the characters in a field in order to make a post on 4Chan.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSlider CAPTCHA\u003c/strong\u003e: A more complex form of the 4Chan CAPTCHA, that consists of a background image with random-looking character fragments, and a foreground image with transparent \u0026#34;holes\u0026#34; or \u0026#34;windows\u0026#34; in it. A slider in the browser CAPTCHA form must be moved to correctly align the two images in order to see the CAPTCHA text.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"getting-the-data\"\u003eGetting the Data\u003c/h2\u003e\n\u003cp\u003eI\u0026#39;ve heard many times that the hardest part of any machine learning problem is getting the data to train your model. This assertion was definitely pertinent here, for several reasons. There\u0026#39;s two parts to this problem: Getting the CAPTCHAs, and getting solutions to those CAPTCHAs.\u003c/p\u003e\n\u003ch3 id=\"scraping-captchas-from-4chan\"\u003eScraping CAPTCHAs from 4Chan\u003c/h3\u003e\n\u003cp\u003eAfter looking at the HTTP requests in the browser console when requesting a new CAPTCHA, I found that it makes a request to \u003ccode\u003ehttps://sys.4chan.org/captcha?framed=1\u0026amp;board={board}\u003c/code\u003e, where \u003ccode\u003e{board}\u003c/code\u003e is the name of the board we\u0026#39;re trying to post on. The response is an HTML document that contains a script tag with a \u003ccode\u003ewindow.parent.postMessage()\u003c/code\u003e call with some JSON. On a hunch, I tried to remove the \u003ccode\u003eframed=1\u003c/code\u003e parameter, and found that this causes it to just spit out the raw JSON. That should be easier to work with. The JSON looks like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\u003cspan\u003e{\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;challenge\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e\u0026#34;[some long and random string here]\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;ttl\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e120\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;cd\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e5\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;img\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e\u0026#34;[a base64 string here]\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;img_width\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e300\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;img_height\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e80\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;bg\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e\u0026#34;[a base64 string here]\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;bg_width\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e349\u003c/span\u003e\n\u003cspan\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSome of these keys are pretty obvious. \u003ccode\u003ettl\u003c/code\u003e and \u003ccode\u003ecd\u003c/code\u003e are the least obvious to me. I know from experience that the 4Chan CAPTCHA only displays for about 2 minutes before it expires and you have to request a new one, so that\u0026#39;s what \u003ccode\u003ettl\u003c/code\u003e must be. But what about \u003ccode\u003ecd\u003c/code\u003e? Let\u0026#39;s make another request, shortly after the first one:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\u003cspan\u003e{\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;error\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e\u0026#34;You have to wait a while before doing this again\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\n    \u003cspan\u003e\u0026#34;cd\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003e23\u003c/span\u003e\n\u003cspan\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIf I keep making the same request, the \u003ccode\u003ecd\u003c/code\u003e parameter steadily decreases, at a rate of about 1 per second. Alright, so this is how long you have to wait before requesting a new CAPTCHA. \u003ccode\u003ecd\u003c/code\u003e likely stands for \u0026#34;cooldown\u0026#34;.\u003c/p\u003e\n\u003cp\u003eIf I wait the 23 seconds, and then make another request, I get a successful response, but this time, the \u003ccode\u003ecd\u003c/code\u003e is 32. We have to wait longer every time. After some experimentation with a script, it looks like the first few requests can be made every 5 seconds, then it increments to 8, and then continues to roughly double until it\u0026#39;s capped at 280 seconds, and stays there.\u003c/p\u003e\n\u003cp\u003eAdditionally, once you\u0026#39;ve hit the 280 second timers, the CAPTCHA gets somewhat harder. It looks like this:\u003c/p\u003e\n\u003cfigure\u003e\u003cimg alt=\"Difficult 4Chan CAPTCHA with several horizontal lines and an oval obscuring the text, in addition to general noise all over the image\" loading=\"lazy\" width=\"100\" height=\"100\" decoding=\"async\" data-nimg=\"1\" sizes=\"100vw\" srcset=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-hard.png\u0026amp;w=640\u0026amp;q=75 640w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-hard.png\u0026amp;w=750\u0026amp;q=75 750w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-hard.png\u0026amp;w=828\u0026amp;q=75 828w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-hard.png\u0026amp;w=1080\u0026amp;q=75 1080w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-hard.png\u0026amp;w=1200\u0026amp;q=75 1200w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-hard.png\u0026amp;w=1920\u0026amp;q=75 1920w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-hard.png\u0026amp;w=2048\u0026amp;q=75 2048w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-hard.png\u0026amp;w=3840\u0026amp;q=75 3840w\" src=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-hard.png\u0026amp;w=3840\u0026amp;q=75\"/\u003e\u003cfigcaption\u003eDifficult 4Chan CAPTCHA with several horizontal lines and an oval obscuring the text, in addition to general noise all over the image\u003c/figcaption\u003e\u003c/figure\u003e\n\u003cp\u003einstead of this:\u003c/p\u003e\n\u003cfigure\u003e\u003cimg alt=\"Easier 4Chan CAPTCHA with one curved line over the text, in addition to general noise all over the image\" loading=\"lazy\" width=\"100\" height=\"100\" decoding=\"async\" data-nimg=\"1\" sizes=\"100vw\" srcset=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-easy.png\u0026amp;w=640\u0026amp;q=75 640w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-easy.png\u0026amp;w=750\u0026amp;q=75 750w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-easy.png\u0026amp;w=828\u0026amp;q=75 828w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-easy.png\u0026amp;w=1080\u0026amp;q=75 1080w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-easy.png\u0026amp;w=1200\u0026amp;q=75 1200w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-easy.png\u0026amp;w=1920\u0026amp;q=75 1920w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-easy.png\u0026amp;w=2048\u0026amp;q=75 2048w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-easy.png\u0026amp;w=3840\u0026amp;q=75 3840w\" src=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-easy.png\u0026amp;w=3840\u0026amp;q=75\"/\u003e\u003cfigcaption\u003eEasier 4Chan CAPTCHA with one curved line over the text, in addition to general noise all over the image\u003c/figcaption\u003e\u003c/figure\u003e\n\u003cp\u003eSo, there\u0026#39;s some throttling in place. The data also gets of lower (but still usable) quality if you make too many requests.\u003c/p\u003e\n\u003cp\u003eSomething I will briefly touch on is that the user has to pass a Cloudflare Turnstile challenge to even request a CAPTCHA in the first place. As a result, simply using many proxies with a naive script is not realistic, without first passing the Cloudflare Turnstile and saving the relevant cookies. When I was scraping CAPTCHAs with the script I wrote for this, I simply copied the Cloudflare cookies from my browser, and manually replaced them whenever they expired.\u003c/p\u003e\n\u003cp\u003eI scraped several hundred CAPTCHAs in this manner - not enough to train the model, but it\u0026#39;s at least a start. This still leaves us with a problem, though. We have all these CAPTCHAs, but we don\u0026#39;t have the solutions. I could fill them out manually, but instead, let\u0026#39;s try something else.\u003c/p\u003e\n\u003ch3 id=\"getting-the-solutions\"\u003eGetting the Solutions\u003c/h3\u003e\n\u003cp\u003eOr, \u003cem\u003eHumans are bad at solving the 4Chan CAPTCHA\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003eA recurring theme in this project has been \u0026#34;this is easy for a computer to do, but hard for a human to do.\u0026#34; Many users find the \u0026#34;slider\u0026#34; style CAPTCHAs incredibly frustrating, but I\u0026#39;ve had a 100% success rate in aligning them with the heuristic script I made (\u003ccode\u003etrainer/captcha_aligner.py\u003c/code\u003e). The 4Chan CAPTCHAs in general are widely considered by users of the site to be frustrating to solve. But, surely, for people who solve CAPTCHAs \u003cem\u003efor a living\u003c/em\u003e, it shouldn\u0026#39;t be an insurmountable challenge, right?\u003c/p\u003e\n\u003cp\u003eI coded a quick script (seen in the project under \u003ccode\u003etrainer/labeler.py\u003c/code\u003e) to send the CAPTCHAs to \u003ca href=\"https://anti-captcha.com/\"\u003ea commercial CAPTCHA solving service\u003c/a\u003e, where real humans would solve the CAPTCHAs for me for a nominal fee. Writing the script was simple, but actually employing it was an exercise in frustration. I sent a couple dozen CAPTCHAs to the service, and nearly all of them came back with one or more characters incorrectly solved.\u003c/p\u003e\n\u003cp\u003eThe service has a feature called \u0026#34;100% Recognition\u0026#34;, which allowed me to specify that all my requests be first sent to \u003ccode\u003en\u003c/code\u003e workers, and if \u003ccode\u003ex\u003c/code\u003e of those workers don\u0026#39;t return the same solution, then send them to up to \u003ccode\u003ey\u003c/code\u003e more workers. It would only return an error after sending the CAPTCHAs to \u003ccode\u003en + y\u003c/code\u003e workers and not getting at least \u003ccode\u003ex\u003c/code\u003e solutions the same. I configured my account with the values \u003ccode\u003en = 2\u003c/code\u003e, \u003ccode\u003ex = 2\u003c/code\u003e, and \u003ccode\u003ey = 3\u003c/code\u003e - that is, initially send the CAPTCHA to 2 workers, and if they don\u0026#39;t both agree, then send them to up to 3 additional workers until two of them agree, or none of them agree.\u003c/p\u003e\n\u003cp\u003eThis improved the situation somewhat. About 80% of the CAPTCHAs were now being successfully solved, and after reviewing the results, 90% of those were correct, but about 10% had errors in them, which indicated that multiple workers were making the same mistakes. This was still less than ideal.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eA quick aside: What if I just ask someone I know to be reliable to do it for me, or even do it myself?\u003c/strong\u003e I explored both of these approaches. I wrote a quick user script that saved the CAPTCHA image and the solution text, and just sat there requesting and solving CAPTCHAs in my free time. I also asked a good friend of mine to do the same. This yielded several hundred images, which I did add to the training set, but in the end this approach was abandoned because we still ran into the throttling problem, and the problem of the CAPTCHAs getting harder (and eventually, near-impossible) if you request too many of them.\u003c/p\u003e\n\u003cp\u003eI begun to wonder if there was a different way to look at this altogether. What if we didn\u0026#39;t need to scrape CAPTCHAs and have them solved by humans?\u003c/p\u003e\n\u003ch3 id=\"generating-synthetic-data\"\u003eGenerating Synthetic Data\u003c/h3\u003e\n\u003cp\u003eWhat if we could generate our own 4Chan CAPTCHAs? 4Chan, and the CAPTCHA it uses, are not open source, so I couldn\u0026#39;t literally run the same code locally. But I could definitely approximate it.\u003c/p\u003e\n\u003cp\u003eThe 4Chan CAPTCHA can be dissected into two main parts. The background, which looks like this:\u003c/p\u003e\n\u003cfigure\u003e\u003cimg alt=\"4Chan CAPTCHA background with the characters removed, leaving only general noise over the image\" loading=\"lazy\" width=\"100\" height=\"100\" decoding=\"async\" data-nimg=\"1\" sizes=\"100vw\" srcset=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-background.png\u0026amp;w=640\u0026amp;q=75 640w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-background.png\u0026amp;w=750\u0026amp;q=75 750w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-background.png\u0026amp;w=828\u0026amp;q=75 828w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-background.png\u0026amp;w=1080\u0026amp;q=75 1080w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-background.png\u0026amp;w=1200\u0026amp;q=75 1200w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-background.png\u0026amp;w=1920\u0026amp;q=75 1920w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-background.png\u0026amp;w=2048\u0026amp;q=75 2048w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-background.png\u0026amp;w=3840\u0026amp;q=75 3840w\" src=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-background.png\u0026amp;w=3840\u0026amp;q=75\"/\u003e\u003cfigcaption\u003e4Chan CAPTCHA background with the characters removed, leaving only general noise over the image\u003c/figcaption\u003e\u003c/figure\u003e\n\u003cp\u003eand the characters, which look like this:\u003c/p\u003e\n\u003cfigure\u003e\u003cimg alt=\"4Chan CAPTCHA character set, the characters 0, 2, 4, A, D, G, H, K, M, N, P, S, X, and Y with general noise and distortion\" loading=\"lazy\" width=\"100\" height=\"100\" decoding=\"async\" data-nimg=\"1\" sizes=\"100vw\" srcset=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-letters.png\u0026amp;w=640\u0026amp;q=75 640w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-letters.png\u0026amp;w=750\u0026amp;q=75 750w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-letters.png\u0026amp;w=828\u0026amp;q=75 828w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-letters.png\u0026amp;w=1080\u0026amp;q=75 1080w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-letters.png\u0026amp;w=1200\u0026amp;q=75 1200w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-letters.png\u0026amp;w=1920\u0026amp;q=75 1920w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-letters.png\u0026amp;w=2048\u0026amp;q=75 2048w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-letters.png\u0026amp;w=3840\u0026amp;q=75 3840w\" src=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-letters.png\u0026amp;w=3840\u0026amp;q=75\"/\u003e\u003cfigcaption\u003e4Chan CAPTCHA character set, the characters 0, 2, 4, A, D, G, H, K, M, N, P, S, X, and Y with general noise and distortion\u003c/figcaption\u003e\u003c/figure\u003e\n\u003cp\u003eWe don\u0026#39;t need to generate our own backgrounds from scratch. It\u0026#39;s a relatively simple computer vision problem to take an image like the 4Chan CAPTCHA, and find all of the large \u003ca href=\"https://docs.opencv.org/3.4/d4/d73/tutorial_py_contours_begin.html\"\u003econtours\u003c/a\u003e in the image, which represent the characters, and remove them. This leaves only the noisy background, as seen in the image above, which was generated using this algorithm.\u003c/p\u003e\n\u003cp\u003eNext, we need to isolate a decent number of characters, and label them with their values. If this was trivial to do with an algorithmic script, well, we wouldn\u0026#39;t be here, because solving the CAPTCHA would also be trivial to do with an algorithmic script :) It\u0026#39;s pretty easy to do this by hand, though, and that\u0026#39;s what I settled on doing. It was annoying. I tagged the characters with \u003ca href=\"https://github.com/microsoft/VoTT\"\u003eVoTT\u003c/a\u003e and then extracted them with a quick and dirty script, which also postprocessed them to make sure it was only the characters in the images. I ended up with 50-150 isolated images of each character. It was during this stage of the project that I realized the 4Chan CAPTCHA incoudes only the characters 0, 2, 4, A, D, G, H, K, M, N, P, S, X, and Y - likely done to avoid ambiguity.\u003c/p\u003e\n\u003cp\u003eNow we just have to put it all together. When extracting the digits, I observed a few patterns in how the characters are usually clustered or spread apart, and so I wrote my script to assemble images with backgrounds according to these formulas. And, of course, since the input character images are labelled, I can easily label the generated synthetic CAPTCHAs with their solutions.\u003c/p\u003e\n\u003ch2 id=\"creating-the-model\"\u003eCreating the Model\u003c/h2\u003e\n\u003cp\u003eNow we\u0026#39;ve got the data, it\u0026#39;s time to train the model. I assembled a model architecture based on some research, after reading several different articles on CAPTCHA solving using neural networks.\nI settled on an \u003cabbr title=\"Long Short-Term Memory\"\u003eLSTM\u003c/abbr\u003e \u003cabbr title=\"Convolutional Neural Network\"\u003eCNN\u003c/abbr\u003e architecture with 3 convolutional/max-pooling layers and 2 LSTM layers.\nA fourth convolutional layer was also tested, but it did not improve performance.\nCTC encoding of the CAPTCHA text was used, because the output was of variable length (either 5 or 6 characters).\nI built the model using \u003ca href=\"https://keras.io/\"\u003eKeras\u003c/a\u003e on top of \u003ca href=\"https://www.tensorflow.org/\"\u003eTensorFlow\u003c/a\u003e.\u003c/p\u003e\n\u003ch3 id=\"processing-the-data\"\u003eProcessing the data\u003c/h3\u003e\n\u003cp\u003eThe input to the model was a mix of pre-aligned slider CAPTCHAs, normal CAPTCHAs, and synthetic CAPTCHAs.\nThe training script took care of ensuring they were 300x80 pixels and converted to pure black-and-white.\u003c/p\u003e\n\u003ch4 id=\"always-read-the-docs\"\u003eAlways read the docs\u003c/h4\u003e\n\u003cp\u003e\u003cem\u003eThe arguments might not be in the order you expect.\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eOne of the important steps in my data processing pipeline was making sure that all the CAPTCHA images are exactly 300x80 pixels.\nSome images from the dataset, namely the older aligned \u0026#34;slider\u0026#34; CAPTCHAs, don\u0026#39;t match this resolution / aspect ratio.\nI could just fix the training data, but it\u0026#39;s better in the end to make the training script able to cope with any data I throw at it.\u003c/p\u003e\n\u003cp\u003eI used \u003ccode\u003etf.image.resize()\u003c/code\u003e for this. \u003ca href=\"https://www.tensorflow.org/api_docs/python/tf/image/resize\"\u003eThe docs\u003c/a\u003e on this are pretty simple,\nfor my use case I just need to pass the input image tensor, and the size, which is probably just a tuple of \u003ccode\u003e(width, height)\u003c/code\u003e, right?\nWell, I made that assumption, and the code ran fine, so I didn\u0026#39;t really give it a second thought.\u003c/p\u003e\n\u003cp\u003eUntil... My model\u0026#39;s performance was absolutely abysmal! Even after training for 32+ epochs,\nthe model barely performed at all on images it had seen before, and it really couldn\u0026#39;t make anything at all of brand new CAPTCHA images,\nyielding seemingly random predictions. What the heck was going on?\u003c/p\u003e\n\u003cp\u003eI decided to actually visualize the images I was feeding into the model, and see what they looked like\n- maybe my black/white thresholding was going wrong?\nI took a random image from the input data after processing, and visualized it, and I got... this:\u003c/p\u003e\n\u003cfigure\u003e\u003cimg alt=\"4Chan CAPTCHA that is vertically stretched to 80x300 pixels and completely unreadable\" loading=\"lazy\" width=\"100\" height=\"100\" decoding=\"async\" data-nimg=\"1\" sizes=\"100vw\" srcset=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-sideways.png\u0026amp;w=640\u0026amp;q=75 640w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-sideways.png\u0026amp;w=750\u0026amp;q=75 750w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-sideways.png\u0026amp;w=828\u0026amp;q=75 828w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-sideways.png\u0026amp;w=1080\u0026amp;q=75 1080w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-sideways.png\u0026amp;w=1200\u0026amp;q=75 1200w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-sideways.png\u0026amp;w=1920\u0026amp;q=75 1920w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-sideways.png\u0026amp;w=2048\u0026amp;q=75 2048w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-sideways.png\u0026amp;w=3840\u0026amp;q=75 3840w\" src=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-sideways.png\u0026amp;w=3840\u0026amp;q=75\"/\u003e\u003cfigcaption\u003e4Chan CAPTCHA that is vertically stretched to 80x300 pixels and completely unreadable\u003c/figcaption\u003e\u003c/figure\u003e\n\u003cp\u003eYeah, you probably saw that coming as soon as I said \u0026#34;probably just a tuple of \u003ccode\u003e(width, height)\u003c/code\u003e\u0026#34;. Turns out it\u0026#39;s not. It is, in fact, a tuple of \u003ccode\u003e(height, width)\u003c/code\u003e! Had I taken the time to read the whole documentation page, I would have found this near the bottom of the page, where it provides more detail on the expected argument. This is definitely a lesson learned - read the documentation thoroughly when working with libraries you\u0026#39;re unfamiliar with, even if you think you know how it works, and especially if things aren\u0026#39;t working how you\u0026#39;d expect.\u003c/p\u003e\n\u003cp\u003eAfter fixing this bug, the training performance looked a lot more promising.\u003c/p\u003e\n\u003ch3 id=\"training-the-model\"\u003eTraining the model\u003c/h3\u003e\n\u003cp\u003eThe final dataset consisted of approximately 500 hand-solved images, and approximately 50,000 synthetically-generated images.\nThe synthetic images were generated based on random samples from approximately 2,500 background images and 50-150 images of each character.\nThis dataset was randomly shuffled, and then segmented 90/10 into training and evaluation sets.\nTraining took approximately 45 seconds per epoch on my NVIDIA RTX A4000 Laptop GPU.\u003c/p\u003e\n\u003cp\u003eAt the end of the first epoch, the loss did not look very promising - it\u0026#39;s still all the way up at 19. During the evaluation callback phase, predictions were nowhere near correct, yielding only 1-2 predicted characters that didn\u0026#39;t match any of the characters in the image. This is to be expected during the early stages of training.\u003c/p\u003e\n\u003cp\u003eLater epochs greatly improved performance. By the end of the fourth epoch, loss decreased to 0.55, and the predictions were already looking good, with 5/5 of the random test predictions at this stage yielding correct results. Loss steadily decreased throughout the rest of the training epochs.\u003c/p\u003e\n\u003cp\u003eAfter experimenting with different numbers of epochs, 8-16 epochs was found to be a good trade-off between time and final model performance.\nLoss stabilized by the 8th epoch, and increasing the epoch count beyond 16 yielded greatly diminishing returns.\u003c/p\u003e\n\u003cfigure\u003e\u003cimg alt=\"Graph of model loss versus epochs, showing initial large decrease followed by steady decline and levelling out\" loading=\"lazy\" width=\"100\" height=\"100\" decoding=\"async\" data-nimg=\"1\" sizes=\"100vw\" srcset=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-loss.png\u0026amp;w=640\u0026amp;q=75 640w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-loss.png\u0026amp;w=750\u0026amp;q=75 750w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-loss.png\u0026amp;w=828\u0026amp;q=75 828w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-loss.png\u0026amp;w=1080\u0026amp;q=75 1080w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-loss.png\u0026amp;w=1200\u0026amp;q=75 1200w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-loss.png\u0026amp;w=1920\u0026amp;q=75 1920w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-loss.png\u0026amp;w=2048\u0026amp;q=75 2048w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-loss.png\u0026amp;w=3840\u0026amp;q=75 3840w\" src=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2F4chan-captcha-loss.png\u0026amp;w=3840\u0026amp;q=75\"/\u003e\u003cfigcaption\u003eGraph of model loss versus epochs, showing initial large decrease followed by steady decline and levelling out\u003c/figcaption\u003e\u003c/figure\u003e\n\u003cp\u003eI wrote a quick test script (\u003ccode\u003etrainer/infer.py\u003c/code\u003e) to infer CAPTCHA solutions in Python. Results were promising on images the model had not seen before, yielding correct solutions in the limited number of test cases I tried.\u003c/p\u003e\n\u003ch2 id=\"using-the-model-in-tensorflowjs\"\u003eUsing the Model in TensorFlow.js\u003c/h2\u003e\n\u003cp\u003eWriting the \u003ca href=\"https://www.tensorflow.org/js\"\u003eTensorFlow.js\u003c/a\u003e code for the user script was quite straightforward. I chose TypeScript for this task. I re-implemented the CAPTCHA alignment algorithm from the Python code, as well as the image preprocessing code. All of this code is located in the \u003ccode\u003euser-scripts/\u003c/code\u003e directory in the repository.\u003c/p\u003e\n\u003cp\u003eThe Python TensorFlow/Keras model formats aren\u0026#39;t compatible with the model format expected by TensorFlow.js. There\u0026#39;s an \u003ca href=\"https://www.tensorflow.org/js/guide/conversion\"\u003eofficial conversion script\u003c/a\u003e, with instructions on how to use it. This should be easy, right?\u003c/p\u003e\n\u003ch3 id=\"the-converter-doesnt-work-on-python-312\"\u003eThe converter doesn\u0026#39;t work on Python 3.12\u003c/h3\u003e\n\u003cp\u003eThis was a pretty simple problem that took awhile to figure out. The official TensorFlow-to-TFJS model converter doesn\u0026#39;t work on Python 3.12. This doesn\u0026#39;t seem to really be documented, and the error messages thrown when you try to use it on Python 3.12 are non-obvious. I tried an older version of Python (3.10) on a hunch, using PyEnv, and it worked like a charm.\u003c/p\u003e\n\u003ch3 id=\"tensorflowjs-doesnt-support-keras-3\"\u003eTensorFlow.js doesn\u0026#39;t support Keras 3\u003c/h3\u003e\n\u003cp\u003eNew problem: The conversion script supports converting Keras 3 models to TensorFlow.js format. The only problem? TensorFlow.js doesn\u0026#39;t support actually reading those converted models. I found this out from a \u003ca href=\"https://discuss.ai.google.dev/t/corrupted-configuration-and-batch-input-shape-loading-pre-trained-layers-model-in-tensorflow-js/24454\"\u003eforum post\u003c/a\u003e, after I spent a bit of time puzzling out why TFJS wouldn\u0026#39;t read the model that the official conversion script output.\u003c/p\u003e\n\u003cp\u003eLuckily, the solution was easy: Use Keras 2. We can do this by training the model with the environment variable \u003ccode\u003eTF_USE_LEGACY_KERAS=1\u003c/code\u003e set, after installing the legacy \u003ccode\u003etf_keras\u003c/code\u003e package. This may require some code changes. In my case, I only had to trivially modify one line. We also have to export the model using the legacy \u003ccode\u003e.h5\u003c/code\u003e model format, and specify that as the input format when running the conversion script.\u003c/p\u003e\n\u003ch2 id=\"real-world-performance\"\u003eReal-World Performance\u003c/h2\u003e\n\u003cp\u003eWe\u0026#39;ve seen the performance on the training dataset, which consists mainly of synthetic images. But it doesn\u0026#39;t matter if it can solve synthetic CAPTCHAs - we care about solving the real ones.\u003c/p\u003e\n\u003cp\u003eGood news: It works great on the real 4Chan CAPTCHA. Solving is fast, taking about 1 second to load the model the first time, and then being imperceptibly quick on subsequent executions. In my experience over hundreds of real CAPTCHAs solved in the browser, the model exhibits a greater than 90% successful solve rate. It rarely gets characters wrong - when it is innacurate, it typically omits a single character entirely. I believe this could be improved with greater training on actual data, or possibly tweaking the CAPTCHA layouts in the synthetic dataset generator.\u003c/p\u003e\n\u003cfigure\u003e\u003cimg alt=\"Animation of requesting a CAPTCHA in the 4Chan post form, and it being automatically solved by the user script.\" loading=\"lazy\" width=\"100\" height=\"100\" decoding=\"async\" data-nimg=\"1\" sizes=\"100vw\" srcset=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2Fdemo.gif\u0026amp;w=640\u0026amp;q=75 640w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2Fdemo.gif\u0026amp;w=750\u0026amp;q=75 750w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2Fdemo.gif\u0026amp;w=828\u0026amp;q=75 828w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2Fdemo.gif\u0026amp;w=1080\u0026amp;q=75 1080w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2Fdemo.gif\u0026amp;w=1200\u0026amp;q=75 1200w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2Fdemo.gif\u0026amp;w=1920\u0026amp;q=75 1920w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2Fdemo.gif\u0026amp;w=2048\u0026amp;q=75 2048w, https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2Fdemo.gif\u0026amp;w=3840\u0026amp;q=75 3840w\" src=\"https://www.nullpt.rs/_next/image?url=%2Fposts%2Fbreaking-the-4chan-captcha%2Fdemo.gif\u0026amp;w=3840\u0026amp;q=75\"/\u003e\u003cfigcaption\u003eAnimation of requesting a CAPTCHA in the 4Chan post form, and it being automatically solved by the user script.\u003c/figcaption\u003e\u003c/figure\u003e\n\u003cp\u003eSmall fun fact: This model has far better accuracy than the human-powered CAPTCHA solving service I described above.\u003c/p\u003e\n\u003ch3 id=\"4-character-captchas\"\u003e4-character CAPTCHAs\u003c/h3\u003e\n\u003cp\u003eWhile I was writing and editing this article after completing the project,\nI noticed that 4Chan begun sometimes serving CAPTCHAs with only 4 characters, rather than the usual 5 and 6-character CAPTCHAs.\nDespite this model only having been trained on 5 and 6-character CAPTCHAs,\nperformance on the 4-character CAPTCHAs is the same as for the 5 and 6-character CAPTCHAs.\u003c/p\u003e\n\u003ch2 id=\"conclusion\"\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eI enjoyed this project a lot. It had a few challenges to overcome, and I learned a ton about machine learning and computer vision in the process. There are surely improvements that can be made, but for now, I\u0026#39;m pleased with the results, because I achieved what I set out to do from the start.\u003c/p\u003e\n\u003cp\u003eI hope you enjoyed reading this write-up as much as I enjoyed writing it, and I hope you learned something too!\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e",
  "readingTime": "19 min read",
  "publishedTime": null,
  "modifiedTime": null
}
