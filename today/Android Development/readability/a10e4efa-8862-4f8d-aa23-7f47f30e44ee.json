{
  "id": "a10e4efa-8862-4f8d-aa23-7f47f30e44ee",
  "title": "Multiplatform Compose and Gradle module metadata abuse",
  "link": "https://jakewharton.com/multiplatform-compose-and-gradle-module-metadata-abuse/",
  "description": "",
  "author": "",
  "published": "2021-11-04T00:00:00+00:00",
  "source": "https://jakewharton.com/atom.xml",
  "categories": null,
  "byline": "",
  "length": 10414,
  "excerpt": "04 November 2021",
  "siteName": "Jake Wharton",
  "favicon": "",
  "text": "Multiplatform Compose and Gradle module metadata abuse 04 November 2021 My primary work project for the better part of a year (named Redwood) is built on top of Compose1 and runs on every platform that Kotlin supports. This of course means Android, but we also have Compose running on iOS, the web, the JVM, and all other native targets. It’s truly a multiplatform Compose project2. Getting Compose to run on all these platforms isn’t as hard as you would think. The Compose runtime is written as multiplatform Kotlin code but Google only ships it compiled for Android. JetBrains goes farther by shipping versions compiled for the web and for the JVM. We simply go the whole distance and compile it for every Kotlin target, while also shipping it as a single Kotlin multiplatform artifact. For a year this worked fine. However, Compose UI recently went stable which meant our Android engineers were eager to start using it in the main app (as opposed to just samples). Upon Compose UI’s introduction D8 fails with a duplicate class error: \u003e Duplicate class androidx.compose.runtime.AbstractApplier found in redwood-compose-runtime (app.cash.redwood:compose-runtime-android:0.1.0-square.15) and runtime-1.0.0-runtime (androidx.compose.runtime:runtime:1.0.0) The androidx.compose.* types are compiled into Redwood’s multiplatform Compose runtime artifact. Compose UI depends on the official Compose runtime for Android which also contains these types. Since the two artifacts have different Maven coordinates, Gradle allows both to be included in the app which eventually causes D8 to complain3. Redwood was already building Compose from the same git SHAs as Google’s release builds. Ideally we could use our own builds for every platform except Android, and then point at Google’s artifact solely for Android. This would allow Gradle to see the two projects as sharing a common dependency thereby de-duplicating the Compose runtime classes. Gradle module metadata The mechanism by which Kotlin multiplatform artifacts resolve the correct dependency is through Gradle’s module metadata format. Gradle Module Metadata is a unique format aimed at improving dependency resolution by making it multi-platform and variant-aware. The module metadata is a JSON document which describes the supported platforms through key/value attributes. For Redwood’s Compose runtime the module metadata looks roughly like this: { \"component\": { \"group\": \"app.cash.redwood\", \"module\": \"compose-runtime\", \"version\": \"0.1.0-square.15\" }, \"variants\": [ { \"name\": \"releaseApiElements-published\", \"attributes\": { \"org.gradle.usage\": \"java-api\", \"org.jetbrains.kotlin.platform.type\": \"androidJvm\" }, \"available-at\": { \"url\": \"../../compose-runtime-android/0.1.0-square.15/compose-runtime-android-0.1.0-square.15.module\", \"group\": \"app.cash.redwood\", \"module\": \"compose-runtime-android\", \"version\": \"0.1.0-square.15\" } }, { \"name\": \"iosArm64ApiElements-published\", \"attributes\": { \"artifactType\": \"org.jetbrains.kotlin.klib\", \"org.gradle.usage\": \"kotlin-api\", \"org.jetbrains.kotlin.native.target\": \"ios_arm64\", \"org.jetbrains.kotlin.platform.type\": \"native\" }, \"available-at\": { \"url\": \"../../compose-runtime-iosarm64/0.1.0-square.15/compose-runtime-iosarm64-0.1.0-square.15.module\", \"group\": \"app.cash.redwood\", \"module\": \"compose-runtime-iosarm64\", \"version\": \"0.1.0-square.15\" } }, ... ] } When a 64-bit iOS ARM target consumes the app.cash.redwood:compose-runtime dependency, Gradle will parse this JSON file and actually resolve the app.cash.redwood:compose-runtime-iosarm64 artifact. It behaves somewhat like an HTTP 302 redirect by replacing the user-friendly Maven coordinate with the canonical platform-specific coordinate. For an Android consumer the artifact redirect resolves to app.cash.redwood:compose-runtime-android which is one of the offending artifact coordinates seen in the duplicate class error from D8. As I mentioned above, what we want is to have this variant redirect to Google’s build of the Compose runtime and not our own. We could try to alter the values in the available-at object to point to Google’s artifact, but according to the Gradle module metadata spec the url key must also point to a metadata file which is something Google does not ship. Thankfully, just below available-at in the spec, the dependencies array affords the ability to point at arbitrary Maven coordinates. This would allow us to define a variant with no available-at but a single dependency item to the associated Google Compose runtime artifact. { \"name\": \"releaseApiElements-published\", \"attributes\": { \"org.gradle.usage\": \"java-api\", \"org.jetbrains.kotlin.platform.type\": \"androidJvm\" }, - \"available-at\": { - \"url\": \"../../compose-runtime-android/0.1.0-square.15/compose-runtime-android-0.1.0-square.15.module\", - \"group\": \"app.cash.redwood\", - \"module\": \"compose-runtime-android\", - \"version\": \"0.1.0-square.15\" - } + \"dependencies\": [ + { + \"group\": \"androidx.compose.runtime\", + \"module\": \"runtime\", + \"version\": { + \"prefers\": \"1.0.4\" + } + } + ] } But the module metadata file is entirely generated by Gradle based on project information. How can we modify it to change the output of only a single variant? Modifying Gradle module metadata Spoiler alert: You can’t. At least not using any stable APIs that Gradle provides4. The best (only?) mechanism that I’ve found is to hook into the module metadata file generation task and perform text-based modification of the JSON immediately after it is generated. First, we define a text file which contains the expected JSON contents to be replaced5. { \"name\": \"releaseApiElements-published\", \"attributes\": { \"org.gradle.usage\": \"java-api\", \"org.jetbrains.kotlin.platform.type\": \"androidJvm\" }, \"available-at\": { \"url\": \"../../compose-runtime-android/{REDWOOD_VERSION}/compose-runtime-android-{REDWOOD_VERSION}.module\", \"group\": \"app.cash.redwood\", \"module\": \"compose-runtime-android\", \"version\": \"{REDWOOD_VERSION}\" } }, { \"name\": \"releaseRuntimeElements-published\", \"attributes\": { \"org.gradle.usage\": \"java-runtime\", \"org.jetbrains.kotlin.platform.type\": \"androidJvm\" }, \"available-at\": { \"url\": \"../../compose-runtime-android/{REDWOOD_VERSION}/compose-runtime-android-{REDWOOD_VERSION}.module\", \"group\": \"app.cash.redwood\", \"module\": \"compose-runtime-android\", \"version\": \"{REDWOOD_VERSION}\" } }, Notice how the {REDWOOD_VERSION} placeholder is used to minimize changes to this file over time. Next, define the replacement JSON in another file. { \"name\": \"releaseApiElements-published\", \"attributes\": { \"org.gradle.usage\": \"java-api\", \"org.jetbrains.kotlin.platform.type\": \"androidJvm\" }, \"dependencies\": [ { \"group\": \"androidx.compose.runtime\", \"module\": \"runtime\", \"version\": { \"prefers\": \"{COMPOSE_VERSION}\" } } ] }, { \"name\": \"releaseRuntimeElements-published\", \"attributes\": { \"org.gradle.usage\": \"java-runtime\", \"org.jetbrains.kotlin.platform.type\": \"androidJvm\" }, \"dependencies\": [ { \"group\": \"androidx.compose.runtime\", \"module\": \"runtime\", \"version\": { \"prefers\": \"{COMPOSE_VERSION}\" } } ] }, Once again we use a special string {COMPOSE_VERSION} to minimize the need to change this file as we update to new Compose versions. Finally, perform this text-based substitution immediately after the file is generated. Here the {REDWOOD_VERSION} and {COMPOSE_VERSION} placeholders are replaced with their real values. tasks.named(\"generateMetadataFileForKotlinMultiplatformPublication\").configure { doLast { String find = file('module_find.txt').text.replace('{REDWOOD_VERSION}', version) String replace = file('module_replace.txt').text.replace('{COMPOSE_VERSION}', versions.compose) File file = outputFile.get().getAsFile() String text = file.text int start = text.indexOf(find) if (start == -1) { throw new RuntimeException(\"Unable to locate module_find.txt contents in module JSON ($file)\") } int end = start + find.length() String newText = text.substring(0, start) + replace + text.substring(end) file.text = newText } } This is some very hacky code, but any unexpected changes to the module metadata format will cause a build failure allowing you to reevaluate the approach. Perhaps in the future Gradle will support this type of transformation with a stable public API. This simple text substitution solves the original duplicate class problem today. And it does so in a way which does not require the consumer to understand the nuances of how the Compose runtime is built. Despite solving the issue for Android builds, we still have the duplicate class problem for the other platforms on which multiple Compose-based projects can be used. If you happened to use Redwood on the JVM with JetBrains’ Compose for Desktop you would have two copies of the Compose runtime (potentially built from different versions). The same is true for targeting the web and using JetBrains’ Compose for Web. Google really should be shipping the Compose runtime as a proper multiplatform artifact for all Kotlin targets to remedy this situation. Unfortunately their Kotlin multiplatform story is a few years behind the community’s need and the prospect of this happening anytime soon is very unlikely. The best we can hope for now is JetBrains to ship a proper multiplatform artifact of the Compose runtime with the same versioning as Google’s and using this hack to point the Android variant at Google’s binary. Then everyone in the multiplatform Compose space could standardize on their artifacts. Until then, however, we’ll continue the imperfect practice of building our own Compose runtime for Redwood and pointing to Google’s artifact for Android6. — Jake Wharton",
  "image": "https://jakewharton.com/static/default_image.png",
  "html": "\u003cdiv id=\"readability-page-1\" class=\"page\"\u003e\u003cdiv\u003e\n      \u003ch2\u003eMultiplatform Compose and Gradle module metadata abuse\u003c/h2\u003e\n      \u003cp\u003e04 November 2021\u003c/p\u003e\n\n      \u003cp\u003eMy primary work project for the better part of a year (named Redwood) is built on top of Compose\u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\"\u003e1\u003c/a\u003e\u003c/sup\u003e and runs on every platform that Kotlin supports. This of course means Android, but we also have Compose running on iOS, the web, the JVM, and all other native targets. It’s truly a multiplatform Compose project\u003csup id=\"fnref:2\"\u003e\u003ca href=\"#fn:2\"\u003e2\u003c/a\u003e\u003c/sup\u003e.\u003c/p\u003e\n\n\u003cp\u003eGetting Compose to run on all these platforms isn’t as hard as you would think. The Compose runtime is written as multiplatform Kotlin code but Google only ships it compiled for Android. JetBrains goes farther by shipping versions compiled for the web and for the JVM. We simply go the whole distance and compile it for every Kotlin target, while also shipping it as a single Kotlin multiplatform artifact.\u003c/p\u003e\n\n\u003cp\u003eFor a year this worked fine. However, Compose UI recently went stable which meant our Android engineers were eager to start using it in the main app (as opposed to just samples). Upon Compose UI’s introduction D8 fails with a duplicate class error:\u003c/p\u003e\n\n\u003cdiv\u003e\u003cpre\u003e\u003ccode\u003e\u0026gt; Duplicate class androidx.compose.runtime.AbstractApplier found in\n  redwood-compose-runtime (app.cash.redwood:compose-runtime-android:0.1.0-square.15) and\n  runtime-1.0.0-runtime (androidx.compose.runtime:runtime:1.0.0)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\n\u003cp\u003eThe \u003ccode\u003eandroidx.compose.*\u003c/code\u003e types are compiled into Redwood’s multiplatform Compose runtime artifact. Compose UI depends on the official Compose runtime for Android which also contains these types. Since the two artifacts have different Maven coordinates, Gradle allows both to be included in the app which eventually causes D8 to complain\u003csup id=\"fnref:3\"\u003e\u003ca href=\"#fn:3\"\u003e3\u003c/a\u003e\u003c/sup\u003e.\u003c/p\u003e\n\n\u003cp\u003eRedwood was already building Compose from the same git SHAs as Google’s release builds. Ideally we could use our own builds for every platform \u003cem\u003eexcept\u003c/em\u003e Android, and then point at Google’s artifact solely for Android. This would allow Gradle to see the two projects as sharing a common dependency thereby de-duplicating the Compose runtime classes.\u003c/p\u003e\n\n\u003ch3 id=\"gradle-module-metadata\"\u003eGradle module metadata\u003c/h3\u003e\n\n\u003cp\u003eThe mechanism by which Kotlin multiplatform artifacts resolve the correct dependency is through Gradle’s \u003ca href=\"https://docs.gradle.org/current/userguide/publishing_gradle_module_metadata.html\"\u003emodule metadata format\u003c/a\u003e.\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eGradle Module Metadata is a unique format aimed at improving dependency resolution by making it multi-platform and variant-aware.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eThe module metadata is a JSON document which describes the supported platforms through key/value attributes. For Redwood’s Compose runtime the module metadata looks roughly like this:\u003c/p\u003e\n\n\u003cdiv\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n  \u003c/span\u003e\u003cspan\u003e\u0026#34;component\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e\u0026#34;group\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;app.cash.redwood\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e\u0026#34;module\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;compose-runtime\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e\u0026#34;version\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;0.1.0-square.15\u0026#34;\u003c/span\u003e\u003cspan\u003e\n  \u003c/span\u003e\u003cspan\u003e},\u003c/span\u003e\u003cspan\u003e\n  \u003c/span\u003e\u003cspan\u003e\u0026#34;variants\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e[\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;releaseApiElements-published\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;attributes\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.gradle.usage\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;java-api\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.jetbrains.kotlin.platform.type\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;androidJvm\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e},\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;available-at\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;url\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;../../compose-runtime-android/0.1.0-square.15/compose-runtime-android-0.1.0-square.15.module\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;group\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;app.cash.redwood\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;module\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;compose-runtime-android\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;version\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;0.1.0-square.15\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e},\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;iosArm64ApiElements-published\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;attributes\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;artifactType\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;org.jetbrains.kotlin.klib\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.gradle.usage\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;kotlin-api\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.jetbrains.kotlin.native.target\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;ios_arm64\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.jetbrains.kotlin.platform.type\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;native\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e},\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;available-at\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;url\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;../../compose-runtime-iosarm64/0.1.0-square.15/compose-runtime-iosarm64-0.1.0-square.15.module\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;group\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;app.cash.redwood\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;module\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;compose-runtime-iosarm64\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;version\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;0.1.0-square.15\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e},\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e...\u003c/span\u003e\u003cspan\u003e\n  \u003c/span\u003e\u003cspan\u003e]\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\n\u003cp\u003eWhen a 64-bit iOS ARM target consumes the \u003ccode\u003eapp.cash.redwood:compose-runtime\u003c/code\u003e dependency, Gradle will parse this JSON file and actually resolve the \u003ccode\u003eapp.cash.redwood:compose-runtime-iosarm64\u003c/code\u003e artifact. It behaves somewhat like an HTTP 302 redirect by replacing the user-friendly Maven coordinate with the canonical platform-specific coordinate.\u003c/p\u003e\n\n\u003cp\u003eFor an Android consumer the artifact redirect resolves to \u003ccode\u003eapp.cash.redwood:compose-runtime-android\u003c/code\u003e which is one of the offending artifact coordinates seen in the duplicate class error from D8. As I mentioned above, what we want is to have this variant redirect to Google’s build of the Compose runtime and not our own.\u003c/p\u003e\n\n\u003cp\u003eWe could try to alter the values in the \u003ccode\u003eavailable-at\u003c/code\u003e object to point to Google’s artifact, but according to the \u003ca href=\"https://github.com/gradle/gradle/blob/master/subprojects/docs/src/docs/design/gradle-module-metadata-latest-specification.md#available-at-value\"\u003eGradle module metadata spec\u003c/a\u003e the \u003ccode\u003eurl\u003c/code\u003e key must also point to a metadata file which is something Google does not ship.\u003c/p\u003e\n\n\u003cp\u003eThankfully, just below \u003ccode\u003eavailable-at\u003c/code\u003e in the spec, the \u003ca href=\"https://github.com/gradle/gradle/blob/master/subprojects/docs/src/docs/design/gradle-module-metadata-latest-specification.md#dependencies-value\"\u003e\u003ccode\u003edependencies\u003c/code\u003e array\u003c/a\u003e affords the ability to point at arbitrary Maven coordinates. This would allow us to define a variant with no \u003ccode\u003eavailable-at\u003c/code\u003e but a single \u003ccode\u003edependency\u003c/code\u003e item to the associated Google Compose runtime artifact.\u003c/p\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003ccode\u003e {\n   \u0026#34;name\u0026#34;: \u0026#34;releaseApiElements-published\u0026#34;,\n   \u0026#34;attributes\u0026#34;: {\n     \u0026#34;org.gradle.usage\u0026#34;: \u0026#34;java-api\u0026#34;,\n     \u0026#34;org.jetbrains.kotlin.platform.type\u0026#34;: \u0026#34;androidJvm\u0026#34;\n   },\n\u003cspan\u003e-  \u0026#34;available-at\u0026#34;: {\n-    \u0026#34;url\u0026#34;: \u0026#34;../../compose-runtime-android/0.1.0-square.15/compose-runtime-android-0.1.0-square.15.module\u0026#34;,\n-    \u0026#34;group\u0026#34;: \u0026#34;app.cash.redwood\u0026#34;,\n-    \u0026#34;module\u0026#34;: \u0026#34;compose-runtime-android\u0026#34;,\n-    \u0026#34;version\u0026#34;: \u0026#34;0.1.0-square.15\u0026#34;\n-  }\n\u003c/span\u003e\u003cspan\u003e+  \u0026#34;dependencies\u0026#34;: [\n+    {\n+      \u0026#34;group\u0026#34;: \u0026#34;androidx.compose.runtime\u0026#34;,\n+      \u0026#34;module\u0026#34;: \u0026#34;runtime\u0026#34;,\n+      \u0026#34;version\u0026#34;: {\n+        \u0026#34;prefers\u0026#34;: \u0026#34;1.0.4\u0026#34;\n+      }\n+    }\n+  ]\n\u003c/span\u003e }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\n\u003cp\u003eBut the module metadata file is entirely generated by Gradle based on project information. How can we modify it to change the output of only a single variant?\u003c/p\u003e\n\n\u003ch3 id=\"modifying-gradle-module-metadata\"\u003eModifying Gradle module metadata\u003c/h3\u003e\n\n\u003cp\u003eSpoiler alert: You can’t. At least not using any stable APIs that Gradle provides\u003csup id=\"fnref:4\"\u003e\u003ca href=\"#fn:4\"\u003e4\u003c/a\u003e\u003c/sup\u003e.\u003c/p\u003e\n\n\u003cp\u003eThe best (only?) mechanism that I’ve found is to hook into the module metadata file generation task and perform text-based modification of the JSON immediately after it is generated.\u003c/p\u003e\n\n\u003cp\u003eFirst, we define a text file which contains the expected JSON contents to be replaced\u003csup id=\"fnref:5\"\u003e\u003ca href=\"#fn:5\"\u003e5\u003c/a\u003e\u003c/sup\u003e.\u003c/p\u003e\n\n\u003cdiv\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan\u003e    \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;releaseApiElements-published\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;attributes\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.gradle.usage\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;java-api\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.jetbrains.kotlin.platform.type\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;androidJvm\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e},\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;available-at\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;url\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;../../compose-runtime-android/{REDWOOD_VERSION}/compose-runtime-android-{REDWOOD_VERSION}.module\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;group\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;app.cash.redwood\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;module\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;compose-runtime-android\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;version\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;{REDWOOD_VERSION}\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;releaseRuntimeElements-published\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;attributes\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.gradle.usage\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;java-runtime\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.jetbrains.kotlin.platform.type\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;androidJvm\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e},\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;available-at\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;url\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;../../compose-runtime-android/{REDWOOD_VERSION}/compose-runtime-android-{REDWOOD_VERSION}.module\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;group\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;app.cash.redwood\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;module\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;compose-runtime-android\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;version\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;{REDWOOD_VERSION}\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\n\u003cp\u003eNotice how the \u003ccode\u003e{REDWOOD_VERSION}\u003c/code\u003e placeholder is used to minimize changes to this file over time.\u003c/p\u003e\n\n\u003cp\u003eNext, define the replacement JSON in another file.\u003c/p\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan\u003e    \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;releaseApiElements-published\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;attributes\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.gradle.usage\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;java-api\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.jetbrains.kotlin.platform.type\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;androidJvm\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e},\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;dependencies\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e[\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n          \u003c/span\u003e\u003cspan\u003e\u0026#34;group\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;androidx.compose.runtime\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n          \u003c/span\u003e\u003cspan\u003e\u0026#34;module\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;runtime\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n          \u003c/span\u003e\u003cspan\u003e\u0026#34;version\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n            \u003c/span\u003e\u003cspan\u003e\u0026#34;prefers\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;{COMPOSE_VERSION}\u0026#34;\u003c/span\u003e\u003cspan\u003e\n          \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e]\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;releaseRuntimeElements-published\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;attributes\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.gradle.usage\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;java-runtime\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e\u0026#34;org.jetbrains.kotlin.platform.type\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;androidJvm\u0026#34;\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e},\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e\u0026#34;dependencies\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e[\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n          \u003c/span\u003e\u003cspan\u003e\u0026#34;group\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;androidx.compose.runtime\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n          \u003c/span\u003e\u003cspan\u003e\u0026#34;module\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;runtime\u0026#34;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n          \u003c/span\u003e\u003cspan\u003e\u0026#34;version\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e\n            \u003c/span\u003e\u003cspan\u003e\u0026#34;prefers\u0026#34;\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e \u003c/span\u003e\u003cspan\u003e\u0026#34;{COMPOSE_VERSION}\u0026#34;\u003c/span\u003e\u003cspan\u003e\n          \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e\n        \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e\n      \u003c/span\u003e\u003cspan\u003e]\u003c/span\u003e\u003cspan\u003e\n    \u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\n\u003cp\u003eOnce again we use a special string \u003ccode\u003e{COMPOSE_VERSION}\u003c/code\u003e to minimize the need to change this file as we update to new Compose versions.\u003c/p\u003e\n\n\u003cp\u003eFinally, perform this text-based substitution immediately after the file is generated. Here the \u003ccode\u003e{REDWOOD_VERSION}\u003c/code\u003e and \u003ccode\u003e{COMPOSE_VERSION}\u003c/code\u003e placeholders are replaced with their real values.\u003c/p\u003e\n\n\u003cdiv\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan\u003etasks\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003enamed\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e\u0026#34;generateMetadataFileForKotlinMultiplatformPublication\u0026#34;\u003c/span\u003e\u003cspan\u003e).\u003c/span\u003e\u003cspan\u003econfigure\u003c/span\u003e \u003cspan\u003e{\u003c/span\u003e\n  \u003cspan\u003edoLast\u003c/span\u003e \u003cspan\u003e{\u003c/span\u003e\n    \u003cspan\u003eString\u003c/span\u003e \u003cspan\u003efind\u003c/span\u003e \u003cspan\u003e=\u003c/span\u003e \u003cspan\u003efile\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e\u0026#39;module_find.txt\u0026#39;\u003c/span\u003e\u003cspan\u003e).\u003c/span\u003e\u003cspan\u003etext\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003ereplace\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e\u0026#39;{REDWOOD_VERSION}\u0026#39;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e \u003cspan\u003eversion\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\n    \u003cspan\u003eString\u003c/span\u003e \u003cspan\u003ereplace\u003c/span\u003e \u003cspan\u003e=\u003c/span\u003e \u003cspan\u003efile\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e\u0026#39;module_replace.txt\u0026#39;\u003c/span\u003e\u003cspan\u003e).\u003c/span\u003e\u003cspan\u003etext\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003ereplace\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e\u0026#39;{COMPOSE_VERSION}\u0026#39;\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e \u003cspan\u003eversions\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003ecompose\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\n\n    \u003cspan\u003eFile\u003c/span\u003e \u003cspan\u003efile\u003c/span\u003e \u003cspan\u003e=\u003c/span\u003e \u003cspan\u003eoutputFile\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003eget\u003c/span\u003e\u003cspan\u003e().\u003c/span\u003e\u003cspan\u003egetAsFile\u003c/span\u003e\u003cspan\u003e()\u003c/span\u003e\n    \u003cspan\u003eString\u003c/span\u003e \u003cspan\u003etext\u003c/span\u003e \u003cspan\u003e=\u003c/span\u003e \u003cspan\u003efile\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003etext\u003c/span\u003e\n\n    \u003cspan\u003eint\u003c/span\u003e \u003cspan\u003estart\u003c/span\u003e \u003cspan\u003e=\u003c/span\u003e \u003cspan\u003etext\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003eindexOf\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003efind\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\n    \u003cspan\u003eif\u003c/span\u003e \u003cspan\u003e(\u003c/span\u003e\u003cspan\u003estart\u003c/span\u003e \u003cspan\u003e==\u003c/span\u003e \u003cspan\u003e-\u003c/span\u003e\u003cspan\u003e1\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e \u003cspan\u003e{\u003c/span\u003e\n      \u003cspan\u003ethrow\u003c/span\u003e \u003cspan\u003enew\u003c/span\u003e \u003cspan\u003eRuntimeException\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e\u0026#34;Unable to locate module_find.txt contents in module JSON ($file)\u0026#34;\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\n    \u003cspan\u003e}\u003c/span\u003e\n    \u003cspan\u003eint\u003c/span\u003e \u003cspan\u003eend\u003c/span\u003e \u003cspan\u003e=\u003c/span\u003e \u003cspan\u003estart\u003c/span\u003e \u003cspan\u003e+\u003c/span\u003e \u003cspan\u003efind\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003elength\u003c/span\u003e\u003cspan\u003e()\u003c/span\u003e\n\n    \u003cspan\u003eString\u003c/span\u003e \u003cspan\u003enewText\u003c/span\u003e \u003cspan\u003e=\u003c/span\u003e \u003cspan\u003etext\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003esubstring\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e0\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e \u003cspan\u003estart\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e \u003cspan\u003e+\u003c/span\u003e \u003cspan\u003ereplace\u003c/span\u003e \u003cspan\u003e+\u003c/span\u003e \u003cspan\u003etext\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003esubstring\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003eend\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\n    \u003cspan\u003efile\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003etext\u003c/span\u003e \u003cspan\u003e=\u003c/span\u003e \u003cspan\u003enewText\u003c/span\u003e\n  \u003cspan\u003e}\u003c/span\u003e\n\u003cspan\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\n\u003cp\u003eThis is some very hacky code, but any unexpected changes to the module metadata format will cause a build failure allowing you to reevaluate the approach. Perhaps in the future Gradle will support this type of transformation \u003ca href=\"https://github.com/gradle/gradle/issues/18862\"\u003ewith a stable public API\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eThis simple text substitution solves the original duplicate class problem today. And it does so in a way which does not require the consumer to understand the nuances of how the Compose runtime is built.\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003eDespite solving the issue for Android builds, we still have the duplicate class problem for the other platforms on which multiple Compose-based projects can be used. If you happened to use Redwood on the JVM with JetBrains’ Compose for Desktop you would have two copies of the Compose runtime (potentially built from different versions). The same is true for targeting the web and using JetBrains’ Compose for Web.\u003c/p\u003e\n\n\u003cp\u003eGoogle really should be shipping the Compose runtime as a proper multiplatform artifact for all Kotlin targets to remedy this situation. Unfortunately their Kotlin multiplatform story is a few years behind the community’s need and the prospect of this happening anytime soon is very unlikely. The best we can hope for now is JetBrains to ship a proper multiplatform artifact of the Compose runtime with the same versioning as Google’s and using this hack to point the Android variant at Google’s binary. Then everyone in the multiplatform Compose space could standardize on their artifacts.\u003c/p\u003e\n\n\u003cp\u003eUntil then, however, we’ll continue the imperfect practice of building our own Compose runtime for Redwood and pointing to Google’s artifact for Android\u003csup id=\"fnref:6\"\u003e\u003ca href=\"#fn:6\"\u003e6\u003c/a\u003e\u003c/sup\u003e.\u003c/p\u003e\n\n\n\n\n      \u003cp\u003e— Jake Wharton\u003c/p\u003e\n    \u003c/div\u003e\u003c/div\u003e",
  "readingTime": "11 min read",
  "publishedTime": "2021-11-04T00:00:00Z",
  "modifiedTime": null
}
